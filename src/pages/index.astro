---
import Layout from '../layouts/Layout.astro';
import ProductCard from '../components/ProductCard.astro';
import FilterSection from '../components/FilterSection.astro';
import { getProducts, getCategories, getFeaturedProducts } from '../lib/queries';
import type { SanityProduct, SanityCategory, ProductCardProps } from '../types/sanity';

// Obtener datos de Sanity
let allProducts: ProductCardProps[] = [];
let categories: SanityCategory[] = [];
let featuredProducts: ProductCardProps[] = [];

try {
  // Obtener todos los productos
  const products = await getProducts();
  allProducts = products.map(product => ({
    _id: product._id,
    name: product.name,
    price: `$${product.price}`,
    image: product.images?.[0] || '/ima1.webp', // Fallback image
    category: product.category || 'Sin categoría',
    inStock: product.inStock,
    color: product.color,
    size: product.size
  }));

  // Obtener categorías
  const categoriesData = await getCategories();
  categories = categoriesData;

  // Obtener productos destacados
  const featured = await getFeaturedProducts(8);
  featuredProducts = featured.map(product => ({
    _id: product._id,
    name: product.name,
    price: `$${product.price}`,
    image: product.images?.[0] || '/ima1.webp',
    category: product.category || 'Sin categoría',
    inStock: product.inStock
  }));

} catch (error) {
  console.error('Error fetching data from Sanity:', error);
  
  // Datos de fallback en caso de error
  allProducts = [
    { _id: '1', name: "Hoodie Urban Black", price: "$89.99", image: "/ima1.webp", category: "Hoodies", inStock: true },
    { _id: '2', name: "Tee Underground", price: "$39.99", image: "/ima5.webp", category: "Camisetas", inStock: true },
    { _id: '3', name: "Cargo Urban", price: "$129.99", image: "/ima10.webp", category: "Pantalones", inStock: true },
    { _id: '4', name: "Cap Urban", price: "$39.99", image: "/ima14.webp", category: "Accesorios", inStock: true },
  ];
  
  categories = [
    { _id: '1', name: 'Hoodies', description: 'Hoodies urbanos' },
    { _id: '2', name: 'Camisetas', description: 'Camisetas de estilo urbano' },
    { _id: '3', name: 'Pantalones', description: 'Pantalones urbanos' },
    { _id: '4', name: 'Accesorios', description: 'Accesorios urbanos' },
  ];
  
  featuredProducts = allProducts.slice(0, 4);
}

// Agrupar productos por categoría para la sección de categorías
const productCategories = categories.map(cat => ({
  category: cat.name,
  products: allProducts.filter(product => product.category === cat.name).slice(0, 4)
}));
---

<Layout title="Back Bone - Catálogo de Ropa Urbana">
  <!-- Hero Section -->
  <section class="relative overflow-hidden">
    <div class="container mx-auto px-4 py-20">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <div>
          <h1 class="text-5xl md:text-7xl font-black mb-6">
            <span class="text-transparent bg-clip-text bg-gradient-to-r from-urban-accent to-urban-secondary">
              BACK BONE
            </span>
            <br>
            <span class="text-urban-white">URBAN WEAR</span>
          </h1>
          <p class="text-xl text-gray-300 mb-8 leading-relaxed">
            Descubre nuestra colección de ropa urbana diseñada para la generación actual. 
            Desde hoodies hasta accesorios, encuentra tu estilo único.
          </p>
          <div class="flex flex-col sm:flex-row gap-4">
            <a href="#productos" class="bg-urban-accent text-urban-black font-bold py-4 px-8 rounded-lg text-lg hover:bg-urban-accent/90 transition-colors">
              Ver Catálogo Completo
            </a>
            <a href="#nuevos" class="border border-urban-secondary text-urban-secondary font-bold py-4 px-8 rounded-lg text-lg hover:bg-urban-secondary hover:text-urban-black transition-all">
              Nuevos Productos
            </a>
          </div>
        </div>
        
        <!-- Image Grid -->
        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-4">
            <div class="aspect-square rounded-2xl overflow-hidden">
              <img src="/imat1.webp" alt="Hoodie urbano" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
            </div>
            <div class="aspect-[3/2] rounded-2xl overflow-hidden">
              <img src="/imat2.webp" alt="Accesorios urbanos" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
            </div>
          </div>
          <div class="space-y-4 mt-8">
            <div class="aspect-[3/2] rounded-2xl overflow-hidden">
              <img src="/imat3.webp" alt="Camisetas urbanas" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
            </div>
            <div class="aspect-square rounded-2xl overflow-hidden">
              <img src="/imat4.webp" alt="Pantalones urbanos" class="w-full h-full object-cover hover:scale-105 transition-transform duration-300" />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Background Pattern -->
    <div class="absolute inset-0 opacity-5">
      <div class="absolute inset-0" style="background-image: radial-gradient(circle at 1px 1px, rgba(255,107,53,0.3) 1px, transparent 0); background-size: 50px 50px;"></div>
    </div>
  </section>

  <!-- Featured Categories -->
  <section class="py-20 bg-gradient-to-r from-urban-black to-urban-gray">
    <div class="container mx-auto px-4">
      <div class="text-center mb-16">
        <h2 class="text-4xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-urban-accent to-urban-secondary">
          CATEGORÍAS DESTACADAS
        </h2>
        <p class="text-gray-400 text-lg">Explora nuestras colecciones más populares</p>
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
        {productCategories.map((category, index) => (
          <div class="group relative">
            <div class="aspect-square bg-gradient-to-br from-urban-gray to-gray-800 rounded-2xl overflow-hidden border border-gray-700 group-hover:border-urban-accent/50 transition-all duration-300">
              <img 
                src={category.products[0].image} 
                alt={category.category}
                class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>
              <div class="absolute bottom-6 left-6">
                <h3 class="text-2xl font-bold text-urban-white mb-2">{category.category}</h3>
                <p class="text-gray-300 mb-3">{category.products.length} productos</p>
                <button class="bg-urban-accent text-urban-black font-bold py-2 px-6 rounded-lg group-hover:bg-urban-accent/90 transition-colors">
                  Ver Colección
                </button>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Products Section -->
  <section id="productos" class="py-20">
    <div class="container mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-4xl font-black mb-4 text-transparent bg-clip-text bg-gradient-to-r from-urban-accent to-urban-secondary">
          TODOS LOS PRODUCTOS
        </h2>
        <p class="text-gray-400 text-lg">{allProducts.length} productos únicos diseñados para el estilo urbano</p>
      </div>

      <!-- Filters -->
      <FilterSection 
        categories={categories} 
        totalProducts={allProducts.length}
      />

      <!-- Products Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 mt-12">
        {allProducts.map((product, index) => (
          <ProductCard 
            _id={product._id}
            name={product.name}
            price={product.price}
            image={product.image}
            category={product.category}
            inStock={product.inStock}
            color={product.color}
            size={product.size}
          />
        ))}
      </div>

      <!-- Load More Button -->
      <div class="text-center mt-16">
        <button class="bg-urban-accent text-urban-black font-bold py-4 px-12 rounded-lg text-lg hover:bg-urban-accent/90 transition-colors">
          Cargar Más Productos
        </button>
      </div>
    </div>
  </section>

  <!-- Newsletter Section -->
  <section class="py-20 bg-gradient-to-r from-urban-accent to-urban-secondary">
    <div class="container mx-auto px-4 text-center">
      <h2 class="text-4xl font-black mb-4 text-urban-black">MANTENTE AL DÍA</h2>
      <p class="text-xl text-urban-black/80 mb-8">Recibe las últimas novedades y ofertas exclusivas en tu correo</p>
      <div class="max-w-md mx-auto flex gap-4">
        <input 
          type="email" 
          placeholder="Tu email"
          class="flex-1 bg-white/90 text-urban-black py-4 px-6 rounded-lg placeholder-gray-600 focus:outline-none focus:bg-white"
        />
        <button class="bg-urban-black text-urban-white font-bold py-4 px-8 rounded-lg hover:bg-urban-gray transition-colors">
          Suscribirse
        </button>
      </div>
    </div>
  </section>
</Layout>
