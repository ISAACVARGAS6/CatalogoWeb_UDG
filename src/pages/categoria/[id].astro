---
import Layout from '../../layouts/Layout.astro';
import ProductCard from '../../components/ProductCard.astro';
import { getProductsByCategory, getCategories } from '../../lib/queries';
import type { SanityCategory, SanityProduct } from '../../types/sanity';

export const prerender = true;

interface Props {
  category: SanityCategory;
}

export async function getStaticPaths() {
  try {
    const categories = await getCategories();
    return categories.map((category) => ({
      params: { id: category._id },
      props: { category }
    }));
  } catch (error) {
    console.error('Error fetching categories:', error);
    return [];
  }
}

const { category }: Props = Astro.props;
let products: SanityProduct[] = [];

if (!category) {
  console.error('No category found in props');
} else {
  try {
    products = await getProductsByCategory(category.name);
  } catch (error) {
    console.error('Error fetching products by category:', error);
  }
}
---

<Layout title={category ? `${category.name} - Back Bone` : 'Categor√≠a - Back Bone'}>
  <div class="min-h-screen bg-urban-black">
    {category ? (
      <>
        <!-- Hero Section -->
        <section class="relative overflow-hidden py-20">
          <div class="container mx-auto px-4">
            <div class="text-center">
              <h1 class="text-5xl md:text-7xl font-black mb-6">
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-urban-accent to-urban-secondary">
                  {category.name.toUpperCase()}
                </span>
              </h1>
              {category.description && (
                <p class="text-xl text-gray-300 mb-8 max-w-2xl mx-auto leading-relaxed">
                  {category.description}
                </p>
              )}
              <p class="text-gray-400">
                {products.length} productos disponibles
              </p>
            </div>
          </div>
          
          <!-- Background Pattern -->
          <div class="absolute inset-0 opacity-5">
            <div class="absolute inset-0" style="background-image: radial-gradient(circle at 1px 1px, rgba(255,107,53,0.3) 1px, transparent 0); background-size: 50px 50px;"></div>
          </div>
        </section>

        <!-- Products Grid -->
        <section class="py-20">
          <div class="container mx-auto px-4">
            {products.length > 0 ? (
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                {products.map((product) => (
                  <ProductCard 
                    _id={product._id}
                    name={product.name}
                    price={`$${product.price}`}
                    image={product.images?.[0] || '/ima1.webp'}
                    category={product.category}
                    inStock={product.inStock}
                    color={product.color}
                    size={product.size}
                  />
                ))}
              </div>
            ) : (
              <div class="text-center py-20">
                <div class="text-6xl mb-4">üòî</div>
                <h2 class="text-2xl font-bold text-urban-white mb-4">No hay productos disponibles</h2>
                <p class="text-gray-400 mb-8">No encontramos productos en esta categor√≠a.</p>
                <a href="/" class="bg-urban-accent text-urban-black font-bold py-3 px-8 rounded-lg hover:bg-urban-accent/90 transition-colors">
                  Volver al Inicio
                </a>
              </div>
            )}
          </div>
        </section>
      </>
    ) : (
      <!-- Error State -->
      <section class="py-20">
        <div class="container mx-auto px-4">
          <div class="text-center py-20">
            <div class="text-6xl mb-4">‚ùå</div>
            <h2 class="text-2xl font-bold text-urban-white mb-4">Categor√≠a no encontrada</h2>
            <p class="text-gray-400 mb-8">La categor√≠a que buscas no existe o ha sido eliminada.</p>
            <a href="/" class="bg-urban-accent text-urban-black font-bold py-3 px-8 rounded-lg hover:bg-urban-accent/90 transition-colors">
              Volver al Inicio
            </a>
          </div>
        </div>
      </section>
    )}
  </div>
</Layout>
